#!/usr/bin/env python3

import os
import sys
import shutil
import subprocess
import argparse

def detect_brew_ncurses_prefix() -> str:
    if sys.platform != "darwin":
        return ""
    if not shutil.which("brew"):
        return ""
    try:
        p = subprocess.run(["brew", "--prefix", "ncurses"], capture_output=True, text=True, check=True)
        prefix = p.stdout.strip()
        return prefix
    except subprocess.CalledProcessError as e:
        print("Error: Homebrew failed to detect ncurses prefix", file=sys.stderr)
        print(e.stderr.strip(), file=sys.stderr)
        exit(e.returncode)

def prepare_env_for_pkg_config(brew_prefix: str) -> dict:
    env = os.environ.copy()
    if brew_prefix:
        pcdir = os.path.join(brew_prefix, "lib", "pkgconfig")
        if os.path.isdir(pcdir):
            existing = env.get("PKG_CONFIG_PATH", "")
            if existing:
                env["PKG_CONFIG_PATH"] = f"{pcdir}:{existing}"
            else:
                env["PKG_CONFIG_PATH"] = pcdir
        # also expose brew prefix value for fallbacks
        env["BREW_NCURSES_PREFIX"] = brew_prefix
    return env

def detect_libs(name: str, env: dict) -> str:
    if shutil.which("pkg-config"):
        try:
            subprocess.run(["pkg-config", "--exists", name], env=env, check=True)
        except subprocess.CalledProcessError as e:
            print(f"Error: pkg-config could not find {name}", file=sys.stderr)
            exit(e.returncode)
        try:
            p = subprocess.run(["pkg-config", "--libs", name], capture_output=True, text=True, env=env, check=True)
            libs = p.stdout.strip()
            return libs
        except subprocess.CalledProcessError as e:
            print(f"Error: pkg-config failed to get libs for {name}", file=sys.stderr)
            print(e.stderr.strip(), file=sys.stderr)
            exit(e.returncode)

def detect_cflags(name: str, env: dict) -> str:
    if shutil.which("pkg-config"):
        try:
            subprocess.run(["pkg-config", "--exists", name], env=env, check=True)
        except subprocess.CalledProcessError as e:
            print(f"Error: pkg-config could not find {name}", file=sys.stderr)
            exit(e.returncode)
        try:
            p = subprocess.run(["pkg-config", "--cflags", name], capture_output=True, text=True, env=env, check=True)
            cflags = p.stdout.strip()
            return cflags
        except subprocess.CalledProcessError as e:
            print(f"Error: pkg-config failed to get cflags for {name}", file=sys.stderr)
            print(e.stderr.strip(), file=sys.stderr)
            exit(e.returncode)

def detect_ncurses_libs_cflags(wide_ncurses: bool, env: dict) -> tuple[str, str]:
    ncurses_libs: str = ""
    ncurses_cflags: str = ""

    nc_name: str = "ncursesw" if wide_ncurses else "ncurses"
    ncurses_libs = detect_libs(nc_name, env)
    if not ncurses_libs:
        ncurses_libs = "-lncursesw" if wide_ncurses else "-lncurses"
    ncurses_cflags = detect_cflags(nc_name, env)
    if wide_ncurses:
        ncurses_cflags = ncurses_cflags + " -D_XOPEN_SOURCE_EXTENDED"

    return ncurses_libs, ncurses_cflags

def main() -> int:
    parser = argparse.ArgumentParser(description="Configure the build system.")
    parser.add_argument("--prefix", default="/usr/local", help="Install prefix (default: /usr/local)")
    parser.add_argument("--disable-wide-ncurses", action="store_true", help="Build without wide-character ncurses support")
    args = parser.parse_args()

    prefix_value: str = args.prefix
    wide_ncurses: bool = not args.disable_wide_ncurses


    env: dict = {}
    if wide_ncurses:
        brew_prefix: str = detect_brew_ncurses_prefix()
        env = prepare_env_for_pkg_config(brew_prefix)
    else:
        env = os.environ.copy()

    ncurses_libs: str = ""
    ncurses_cflags: str = ""
    ncurses_libs, ncurses_cflags = detect_ncurses_libs_cflags(wide_ncurses, env)

    # Write config.mk
    with open("config.mk", "w") as f:
        f.write("# Generated by ./configure\n")
        f.write(f"PREFIX := {prefix_value}\n")
        f.write(f"WIDE_NCURSES := {'yes' if wide_ncurses else 'no'}\n")
        f.write(f"NCURSES_LIBS := {ncurses_libs}\n")
        f.write(f"NCURSES_CFLAGS := {ncurses_cflags}\n")

    # Print summary
    print(f"Install prefix: {prefix_value}")
    print(f"Wide-character ncurses: {'enabled' if wide_ncurses else 'disabled'}")
    print(f"NCURSES_LIBS: {ncurses_libs}")
    print(f"NCURSES_CFLAGS: {ncurses_cflags}")
    print("Run 'make' to build and 'make install' to install.")
    return 0

if __name__ == '__main__':
    sys.exit(main())
