#!/usr/bin/env sh

set -e

prefix_default="/usr/local"
prefix_value="$prefix_default"
wide_ncurses="no"
ncurses_libs="-lncurses"
ncurses_cflags=""

usage() {
    cat <<EOF
Usage: $0 [OPTIONS]

Options:
  --prefix=PATH            Installation prefix (default: $prefix_default)
  --enable-wide-ncurses    Build with wide-character ncurses support
  -h, --help               Show this help message
EOF
}

while [ "$#" -gt 0 ]; do
    case "$1" in
        --prefix=*)
            prefix_value="${1#*=}"
            if [ -z "$prefix_value" ]; then
                echo "error: --prefix requires a path" >&2
                exit 1
            fi
            ;;
        --prefix)
            if [ -z "${2-}" ]; then
                echo "error: --prefix requires a path" >&2
                exit 1
            fi
            prefix_value="$2"
            shift
            ;;
        --enable-wide-ncurses)
            wide_ncurses="yes"
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "error: unknown option: $1" >&2
            usage
            exit 1
            ;;
    esac
    shift
done

# Detect Homebrew ncurses on macOS
if [ "$(uname)" = "Darwin" ] && command -v brew >/dev/null 2>&1; then
    BREW_NCURSES_PREFIX=$(brew --prefix ncurses 2>/dev/null || true)
    if [ -n "$BREW_NCURSES_PREFIX" ] && [ -d "$BREW_NCURSES_PREFIX/lib/pkgconfig" ]; then
        export PKG_CONFIG_PATH="$BREW_NCURSES_PREFIX/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
    fi
fi

detect_ncurses() {
    name="$1"
    default_libs="$2"
    if command -v pkg-config >/dev/null 2>&1 && pkg-config --exists "$name"; then
        echo "$(pkg-config --libs "$name")"
    else
        echo "$default_libs"
    fi
}

detect_ncurses_cflags() {
    name="$1"
    if command -v pkg-config >/dev/null 2>&1 && pkg-config --exists "$name"; then
        echo "$(pkg-config --cflags "$name")"
    else
        echo ""
    fi
}

if [ "$wide_ncurses" = "yes" ]; then
    ncurses_libs="$(detect_ncurses ncursesw -lncursesw)"
    ncurses_cflags="$(detect_ncurses_cflags ncursesw) -D_XOPEN_SOURCE_EXTENDED"
else
    ncurses_libs="$(detect_ncurses ncurses -lncurses)"
    ncurses_cflags="$(detect_ncurses_cflags ncurses)"
fi

cat > config.mk <<EOF
# Generated by ./configure
PREFIX := $prefix_value
WIDE_NCURSES := $wide_ncurses
NCURSES_LIBS := $ncurses_libs
NCURSES_CFLAGS := $ncurses_cflags
EOF

echo "Configured prefix: $prefix_value"
if [ "$wide_ncurses" = "yes" ]; then
    echo "Wide-character ncurses: enabled"
else
    echo "Wide-character ncurses: disabled"
fi
echo "NCURSES_LIBS: $ncurses_libs"
echo "NCURSES_CFLAGS: $ncurses_cflags"
echo "Run 'make' to build and 'make install' to install."
